name: Deploy Todo App

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Frontend
        working-directory: frontend
        run: |
          npm install
          VITE_API_URL=/api npm run build

      - name: Debug SSH
        run: |
          whoami
          ls -la /home/runner/.ssh/
          ssh -i /home/runner/.ssh/id_rsa -o StrictHostKeyChecking=no -v root@10.0.1.8 "echo connected"

      - name: Deploy Frontend to Web Servers
        run: |
          scp -i /home/runner/.ssh/id_rsa -o StrictHostKeyChecking=no -r $GITHUB_WORKSPACE/frontend/dist/* root@10.0.1.8:/var/www/html/
          scp -i /home/runner/.ssh/id_rsa -o StrictHostKeyChecking=no -r $GITHUB_WORKSPACE/frontend/dist/* root@10.0.1.9:/var/www/html/

      - name: Deploy Backend to WAS Servers
        run: |
          # WAS-1 (자기 자신)
          mkdir -p /home/runner/app
          cp -r $GITHUB_WORKSPACE/backend/* /home/runner/app/
          cd /home/runner/app && npm install --production
          pm2 restart todo-api || pm2 start src/index.js --name todo-api

          # WAS-2
          ssh -i /home/runner/.ssh/id_rsa -o StrictHostKeyChecking=no root@10.0.3.9 "mkdir -p /root/app"
          scp -i /home/runner/.ssh/id_rsa -o StrictHostKeyChecking=no -r $GITHUB_WORKSPACE/backend/* root@10.0.3.9:/root/app/
          ssh -i /home/runner/.ssh/id_rsa -o StrictHostKeyChecking=no root@10.0.3.9 "cd /root/app && npm install --production && (pm2 restart todo-api || pm2 start src/index.js --name todo-api)"

      - name: Reload Nginx
        run: |
          ssh -i /home/runner/.ssh/id_rsa -o StrictHostKeyChecking=no root@10.0.1.8 "systemctl reload nginx"
          ssh -i /home/runner/.ssh/id_rsa -o StrictHostKeyChecking=no root@10.0.1.9 "systemctl reload nginx"
